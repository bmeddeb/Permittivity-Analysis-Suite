{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ trial.filename }}</li>
                </ol>
            </nav>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="card-title mb-1" data-trial-name="{{ trial.filename }}">{{ trial.filename }}</h3>
                        <p class="text-muted mb-0">Uploaded: {{ trial.upload_timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="edit-trial-btn" title="Edit trial name">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" id="delete-trial-btn" title="Delete trial">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Table Control Buttons -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Material Data</h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="edit-mode-btn">
                                <i class="bi bi-pencil-square"></i> Edit Data
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm" id="add-row-btn" style="display: none;">
                                <i class="bi bi-plus-lg"></i> Add Row
                            </button>
                            <button type="button" class="btn btn-success btn-sm" id="save-mode-btn" style="display: none;">
                                <i class="bi bi-check-lg"></i> Save Changes
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="cancel-mode-btn" style="display: none;">
                                <i class="bi bi-x-lg"></i> Cancel
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="material-data-table">
                            <thead class="table-dark">
                                <tr>
                                    <th>Frequency (GHz)</th>
                                    <th>Dk (Dielectric Constant)</th>
                                    <th>Df (Dissipation Factor)</th>
                                    <th width="80">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for data in material_data %}
                                <tr data-data-id="{{ data.id }}">
                                    <td>{{ "%.3f"|format(data.frequency_ghz) }}</td>
                                    <td>{{ "%.3f"|format(data.dk) }}</td>
                                    <td>{{ "%.6f"|format(data.df) }}</td>
                                    <td></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Bottom Table Controls -->
                    <div class="d-flex justify-content-between align-items-center mt-3" id="bottom-controls" style="display: none !important;">
                        <div class="text-muted">
                            <small>
                                <i class="bi bi-info-circle"></i> 
                                <span class="scroll-to-top-link" style="cursor: pointer; text-decoration: underline;" onclick="scrollToTop()">
                                    Scroll to top for additional controls
                                    <i class="bi bi-arrow-up-circle ms-1"></i>
                                </span>
                            </small>
                        </div>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-success btn-sm" id="add-row-btn-bottom" style="display: none;">
                                <i class="bi bi-plus-lg"></i> Add Row
                            </button>
                            <button type="button" class="btn btn-success btn-sm" id="save-mode-btn-bottom" style="display: none;">
                                <i class="bi bi-check-lg"></i> Save Changes
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="cancel-mode-btn-bottom" style="display: none;">
                                <i class="bi bi-x-lg"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Hidden form for trial deletion -->
            <form id="delete-trial-form" method="POST" action="{{ url_for('main.delete_trial', trial_id=trial.id) }}" style="display: none;">
            </form>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5>Trial Summary</h5>
                </div>
                <div class="card-body">
                    <p><strong>File:</strong> <span data-trial-name="{{ trial.filename }}">{{ trial.filename }}</span></p>
                    <p><strong>Data Points:</strong> <span data-stat="data-points">{{ material_data|length }}</span></p>
                    <p><strong>Upload Date:</strong> {{ trial.upload_timestamp.strftime('%Y-%m-%d') }}</p>
                    <p><strong>Time:</strong> {{ trial.upload_timestamp.strftime('%H:%M:%S') }}</p>
                    
                    {% if material_data %}
                    <hr>
                    <h6>Data Range:</h6>
                    <p><strong>Frequency:</strong><br>
                       <span data-stat="freq-range">{{ "%.3f"|format(material_data|map(attribute='frequency_ghz')|min) }} - 
                       {{ "%.3f"|format(material_data|map(attribute='frequency_ghz')|max) }} GHz</span></p>
                    
                    <p><strong>Dk:</strong><br>
                       <span data-stat="dk-range">{{ "%.3f"|format(material_data|map(attribute='dk')|min) }} - 
                       {{ "%.3f"|format(material_data|map(attribute='dk')|max) }}</span></p>
                    
                    <p><strong>Df:</strong><br>
                       <span data-stat="df-range">{{ "%.6f"|format(material_data|map(attribute='df')|min) }} - 
                       {{ "%.6f"|format(material_data|map(attribute='df')|max) }}</span></p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Charts Section -->
            {% if material_data %}
            <div class="card mt-3">
                <div class="card-header">
                    <h6><i class="bi bi-bar-chart"></i> Data Visualization</h6>
                </div>
                <div class="card-body p-2">
                    <!-- Dk Chart -->
                    <div id="dk-chart" style="height: 250px;"></div>
                    <hr class="my-2">
                    <!-- Df Chart -->
                    <div id="df-chart" style="height: 250px;"></div>
                </div>
            </div>
            {% endif %}
            
            <!-- Action Buttons -->
            <div class="card mt-3">
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('main.download_trial_csv', trial_id=trial.id) }}" class="btn btn-success">
                            <i class="bi bi-download"></i> Download CSV
                        </a>
                        <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">
                            <i class="bi bi-graph-up"></i> View in Dashboard
                        </a>
                        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-house"></i> Back to Home
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Help Card -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6><i class="bi bi-question-circle"></i> How to Edit</h6>
                </div>
                <div class="card-body">
                    <small class="text-muted">
                        <ul class="mb-0">
                            <li>Click <strong>"Edit Data"</strong> to make the table editable</li>
                            <li>Click <strong>"Add Row"</strong> to insert new data points</li>
                            <li>Click on any cell to modify values</li>
                            <li>Use the trash icon to delete individual rows</li>
                            <li>Click <strong>"Save Changes"</strong> to apply modifications</li>
                            <li>Click <strong>"Cancel"</strong> to discard changes</li>
                        </ul>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

{% if material_data %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Prepare data for charts
    const materialData = [
        {% for data in material_data %}
        {
            frequency: {{ data.frequency_ghz }},
            dk: {{ data.dk }},
            df: {{ data.df }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Sort data by frequency for better visualization
    materialData.sort((a, b) => a.frequency - b.frequency);
    
    const frequencies = materialData.map(d => d.frequency);
    const dkValues = materialData.map(d => d.dk);
    const dfValues = materialData.map(d => d.df);
    
    // Dk Chart Configuration
    const dkTrace = {
        x: frequencies,
        y: dkValues,
        type: 'scatter',
        mode: 'lines+markers',
        name: 'Dk',
        line: {
            color: '#0d6efd',
            width: 2
        },
        marker: {
            size: 6,
            color: '#0d6efd'
        }
    };
    
    const dkLayout = {
        title: {
            text: 'Dielectric Constant (Dk) vs Frequency',
            font: { size: 14 }
        },
        xaxis: {
            title: 'Frequency (GHz)',
            titlefont: { size: 12 }
        },
        yaxis: {
            title: 'Dk',
            titlefont: { size: 12 }
        },
        margin: { l: 50, r: 20, t: 40, b: 40 },
        showlegend: false,
        plot_bgcolor: '#f8f9fa',
        paper_bgcolor: 'white'
    };
    
    // Df Chart Configuration
    const dfTrace = {
        x: frequencies,
        y: dfValues,
        type: 'scatter',
        mode: 'lines+markers',
        name: 'Df',
        line: {
            color: '#198754',
            width: 2
        },
        marker: {
            size: 6,
            color: '#198754'
        }
    };
    
    const dfLayout = {
        title: {
            text: 'Dissipation Factor (Df) vs Frequency',
            font: { size: 14 }
        },
        xaxis: {
            title: 'Frequency (GHz)',
            titlefont: { size: 12 }
        },
        yaxis: {
            title: 'Df',
            titlefont: { size: 12 }
        },
        margin: { l: 50, r: 20, t: 40, b: 40 },
        showlegend: false,
        plot_bgcolor: '#f8f9fa',
        paper_bgcolor: 'white'
    };
    
    // Chart configuration options
    const config = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d', 'autoScale2d', 'toggleHover'],
        displaylogo: false
    };
    
    // Create charts
    Plotly.newPlot('dk-chart', [dkTrace], dkLayout, config);
    Plotly.newPlot('df-chart', [dfTrace], dfLayout, config);
});
</script>
{% endif %}

{% endblock %}